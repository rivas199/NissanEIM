<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Integración GPAS (EIM) + Tickets Jira</title>
  <!-- Mantén la ruta de tu hoja de estilos original -->
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <header>
    <h1>Mi Página de GPAS (EIM) + Tickets Jira</h1>
  </header>

  <!-- Sección donde mostramos resultados de GPAS/EIM -->
  <section id="gpas-section">
    <h2>Datos de EIM (GPAS)</h2>
    <div id="gpas-results">Cargando datos de EIM...</div>
  </section>

  <!-- Sección para mostrar los tickets de Jira por día -->
  <section id="jira-section">
    <h2>Tickets por día (Jira)</h2>
    <div id="jira-tickets">Cargando tickets Jira...</div>
  </section>

  <script>
    /********************************************************************
     * 1) CÓDIGO PREVIO DE EIM (GPAS) - SIN MODIFICAR
     *    Aquí va la lógica que ya te funcionaba para llamar a tu Netlify
     *    function o API de GPAS/EIM. Pégala tal cual.
     ********************************************************************/
    (async function fetchEIM() {
      try {
        // Ejemplo que llama a /.netlify/functions/proxy o el nombre que uses
        // Mantén exactamente lo que tenías antes
        const response = await fetch('/.netlify/functions/proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            // Tus parámetros EIM
            someParam: 'value',
            anotherParam: '123'
          })
        });

        if (!response.ok) {
          throw new Error('Error al obtener datos de GPAS/EIM');
        }

        const data = await response.json();

        // Mostrar en la página
        document.getElementById('gpas-results').textContent =
          JSON.stringify(data, null, 2);

      } catch (error) {
        document.getElementById('gpas-results').textContent =
          'Error en EIM: ' + error.message;
        console.error('Error en fetchEIM:', error);
      }
    })();

    /********************************************************************
     * 2) LÓGICA DE TICKETS POR DÍA (Jira)
     *    Se agrega para que, además, puedas ver el conteo P1,P2,P3.
     ********************************************************************/
    (async function fetchJiraTicketsByDay() {
      try {
        // Fechas de ejemplo: ajusta según necesites
        const START_DATE = '2025-02-01';
        const END_DATE   = '2025-02-07';

        // Llamada a tu netlify function ticketsByDay
        const url = `/.netlify/functions/ticketsByDay?start=${START_DATE}&end=${END_DATE}`;
        const res = await fetch(url);

        if (!res.ok) {
          throw new Error('Error al obtener tickets de Jira (ticketsByDay)');
        }

        const data = await res.json();
        // data.dailyCounts: { "2025-02-01": { p1, p2, p3 }, ... }
        const dailyCounts = data.dailyCounts || {};

        // Construimos tabla
        let html = '<table class="jira-table">';
        html += '<thead><tr><th>Fecha</th><th>P1</th><th>P2</th><th>P3</th></tr></thead>';
        html += '<tbody>';

        for (const [date, counts] of Object.entries(dailyCounts)) {
          html += `<tr>
            <td>${date}</td>
            <td>${counts.p1}</td>
            <td>${counts.p2}</td>
            <td>${counts.p3}</td>
          </tr>`;
        }
        html += '</tbody></table>';

        document.getElementById('jira-tickets').innerHTML = html;

      } catch (error) {
        document.getElementById('jira-tickets').textContent =
          'Error: ' + error.message;
        console.error('Error en fetchJiraTicketsByDay:', error);
      }
    })();
  </script>
</body>
</html>
