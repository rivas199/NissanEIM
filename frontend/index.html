<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Integración EIM (GPAS) + Jira Tickets</title>
</head>
<body>
  <h1>Aplicación Nissan: EIM + Tickets por Día</h1>

  <!-- Sección EIM (lo que ya tenías) -->
  <div>
    <h2>Datos de EIM (GPAS)</h2>
    <pre id="eim-result">Cargando EIM...</pre>
  </div>

  <!-- Sección Jira Tickets por día -->
  <div>
    <h2>Tickets Jira por día (P1, P2, P3)</h2>
    <div id="jira-tickets">Cargando Jira...</div>
  </div>

  <script>
  /**************************************************************
   * 1) LLAMADA A EIM/GPAS (ya existente)
   *    Respeta tu código, asumiendo que antes llamabas a /proxy
   **************************************************************/
  async function fetchEIM() {
    try {
      // EJEMPLO, si llamabas a tu netlify function "proxy.js" con POST:
      // (Sustituye por tu fetch real, tal cual lo tenías)
      const response = await fetch('/.netlify/functions/proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          // Parámetros que enviabas a EIM...
          query: 'algo',
          user: 'miUsuario'
        })
      });

      if (!response.ok) {
        throw new Error('Error en la llamada a EIM/GPAS');
      }

      const data = await response.json();
      document.getElementById('eim-result').textContent =
        JSON.stringify(data, null, 2);

    } catch (error) {
      document.getElementById('eim-result').textContent =
        'Error EIM: ' + error.message;
      console.error(error);
    }
  }

  /**************************************************************
   * 2) LLAMADA A JIRA ticketsByDay
   **************************************************************/
  async function fetchJiraTicketsByDay() {
    try {
      // Ajusta el rango de fechas
      const START_DATE = '2025-02-01';
      const END_DATE   = '2025-02-07';

      // Llamada a la netlify function "jiraTicketsByDay.js"
      const url = `/.netlify/functions/jiraTicketsByDay?start=${START_DATE}&end=${END_DATE}`;
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error('Error en la llamada a jiraTicketsByDay');
      }

      // La respuesta JSON debe traer un objeto:
      // { dailyCounts: { "2025-02-01": {p1, p2, p3}, ... } }
      const data = await res.json();

      // data.dailyCounts es el diccionario con los conteos día a día
      const dailyCounts = data.dailyCounts || {};

      // Construimos una tabla
      let html = '<table border="1" cellspacing="0" cellpadding="5">';
      html += '<tr><th>Fecha</th><th>P1</th><th>P2</th><th>P3</th></tr>';

      for (const [date, counts] of Object.entries(dailyCounts)) {
        html += `<tr>
          <td>${date}</td>
          <td>${counts.p1}</td>
          <td>${counts.p2}</td>
          <td>${counts.p3}</td>
        </tr>`;
      }

      html += '</table>';
      document.getElementById('jira-tickets').innerHTML = html;

    } catch (error) {
      document.getElementById('jira-tickets').textContent =
        'Error Jira: ' + error.message;
      console.error(error);
    }
  }

  // Al cargar la página, invocamos ambas llamadas
  fetchEIM();                // Lógica EIM
  fetchJiraTicketsByDay();   // Nueva lógica Jira
  </script>

</body>
</html>
